<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PANDU-GI PRO | Operational Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0284c7;
            --primary-dark: #0369a1;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
        }

        /* --- HEADER FIXED --- */
        .header {
            background: var(--surface);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--border);
        }
        
        .app-brand {
            font-weight: 800;
            font-size: 18px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back {
            display: none;
            background: #f1f5f9;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-sub);
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-back:hover { background: #e2e8f0; color: var(--text-main); }

        /* --- CONTAINER --- */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 90vh;
        }

        /* --- MENU GRID --- */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 10px;
            animation: fadeUp 0.4s ease;
        }

        .menu-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.1s, border-color 0.2s;
        }
        .menu-card:active { transform: scale(0.96); background: #f8fafc; }
        .menu-card:hover { border-color: var(--primary); }

        .menu-icon-box {
            width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; font-size: 24px;
        }
        .ic-blue { background: #e0f2fe; color: #0284c7; }
        .ic-green { background: #dcfce7; color: #16a34a; }
        .ic-orange { background: #ffedd5; color: #ea580c; }
        .ic-gray { background: #f1f5f9; color: #475569; }

        .menu-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; color: var(--text-main); }
        .menu-desc { font-size: 11px; color: var(--text-sub); font-weight: 500; }

        /* --- SECTIONS --- */
        .app-section { display: none; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .app-section.active { display: block; }

        /* --- CARDS & UI --- */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            position: relative;
        }
        .card.trip-alarm { border-left: 5px solid var(--danger); }
        
        .badge {
            display: inline-block; padding: 4px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700; background: #e0f2fe; color: var(--primary-dark); margin-bottom: 8px;
        }
        .card-title { font-size: 16px; font-weight: 700; margin: 0 0 8px 0; }
        .card-desc { font-size: 13px; color: var(--text-sub); margin: 0; line-height: 1.5; margin-bottom: 6px; }
        .card-label { font-weight: 600; font-size: 12px; color: var(--text-main); display: block; margin-top: 8px; }

        .btn {
            border: none; padding: 10px 16px; border-radius: 10px;
            font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex;
            align-items: center; justify-content: center; gap: 6px; transition: 0.2s;
        }
        .btn-full { width: 100%; padding: 14px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-secondary { background: #f1f5f9; color: var(--text-main); }
        .btn-success { background: var(--success); color: white; }

        .delete-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            color: #cbd5e1; cursor: pointer; padding: 5px;
        }
        .delete-btn:hover { color: var(--danger); }

        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 8px; font-family: inherit; margin-bottom: 12px; font-size: 14px;
        }
        
        .search-bar-wrapper { position: sticky; top: 73px; z-index: 90; background: var(--bg); padding-bottom: 10px; }
        .search-bar {
            width: 100%; padding: 14px 16px; border: 2px solid var(--border);
            border-radius: 12px; font-size: 15px; background: var(--surface);
            box-shadow: var(--shadow-sm); transition: border-color 0.2s;
        }
        .search-bar:focus { outline: none; border-color: var(--primary); }

        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal {
            background: white; width: 100%; max-width: 450px; border-radius: 20px;
            padding: 24px; max-height: 85vh; overflow-y: auto;
            animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #loader {
            position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8);
            z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-sub); }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUpModal { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="header">
    <div class="app-brand">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
        PANDU-GI PRO
    </div>
    <button id="btn-home" class="btn-back" onclick="goHome()">
        ‚Üê Menu Utama
    </button>
</div>

<div class="container">

    <div id="main-menu">
        <div style="margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 22px;">Halo, Operator üëã</h2>
            <p style="margin: 4px 0 0 0; color: var(--text-sub); font-size: 14px;">Pilih menu operasional hari ini.</p>
        </div>

        <div class="menu-grid">
            <div class="menu-card" onclick="openSection('section-alarm')">
                <div class="menu-icon-box ic-blue">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                </div>
                <div class="menu-title">Cari Alarm</div>
                <div class="menu-desc">Database Annunciator</div>
            </div>
            <div class="menu-card" onclick="openSection('section-sop')">
                <div class="menu-icon-box ic-green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                </div>
                <div class="menu-title">Dokumen SOP</div>
                <div class="menu-desc">Manual Book PDF</div>
            </div>
            <div class="menu-card" onclick="openSection('section-contact')">
                <div class="menu-icon-box ic-orange">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </div>
                <div class="menu-title">Kontak</div>
                <div class="menu-desc">Nomor Darurat</div>
            </div>
            <div class="menu-card" onclick="openSection('section-data')">
                <div class="menu-icon-box ic-gray">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </div>
                <div class="menu-title">Data</div>
                <div class="menu-desc">Backup & Restore</div>
            </div>
        </div>
    </div>

    <div id="section-alarm" class="app-section">
        <div class="search-bar-wrapper">
            <input type="text" id="search-input" class="search-bar" placeholder="Ketik unit atau nama alarm..." oninput="renderAlarms()">
        </div>
        <button class="btn btn-primary btn-full" style="margin-bottom:15px;" onclick="openModal('modal-alarm')">+ Tambah Data Alarm</button>
        <div id="alarm-list"></div>
    </div>

    <div id="section-sop" class="app-section">
        <h2 style="margin-top:0">Dokumen SOP</h2>
        <div class="card">
            <h3 class="card-title">Upload SOP (PDF)</h3>
            <p class="card-desc" style="margin-bottom:15px">Simpan file PDF manual book di sini (Tersimpan Lokal).</p>
            <input type="text" id="sop-name" placeholder="Nama Dokumen (misal: Manual Trafo)">
            <input type="file" id="sop-file" accept="application/pdf">
            <button class="btn btn-primary btn-full" onclick="addSOP()">Simpan Dokumen</button>
        </div>
        <h4 style="margin: 15px 0 10px 5px;">Daftar Dokumen</h4>
        <div id="sop-list"></div>
    </div>

    <div id="section-contact" class="app-section">
        <h2 style="margin-top:0">Kontak Darurat</h2>
        <button class="btn btn-primary btn-full" style="margin-bottom:15px;" onclick="openModal('modal-contact')">+ Tambah Kontak</button>
        <div id="contact-list"></div>
    </div>

    <div id="section-data" class="app-section">
        <h2 style="margin-top:0">Pengaturan Data</h2>
        <div class="card">
            <h3 class="card-title">Backup & Restore</h3>
            <p class="card-desc" style="margin-bottom:15px">Simpan database alarm & kontak ke file JSON.</p>
            <button class="btn btn-secondary btn-full" onclick="backupData()">üì§ Download Backup (.json)</button>
            <div style="margin: 20px 0; border-top: 1px solid #eee;"></div>
            <p class="card-desc">Restore dari file:</p>
            <input type="file" id="restore-file" accept=".json">
            <button class="btn btn-success btn-full" onclick="restoreData()">üì• Restore Data</button>
        </div>
        <div class="card" style="background:#fff1f2; border-color:#fecdd3;">
            <h3 class="card-title" style="color:#e11d48">Reset Aplikasi</h3>
            <p class="card-desc">Hapus semua data (Alarm, SOP, Kontak) dari browser ini.</p>
            <button class="btn btn-danger btn-full" style="margin-top:10px" onclick="clearAllData()">Hapus Semua Data</button>
        </div>
    </div>

</div>

<div id="modal-alarm" class="overlay">
    <div class="modal">
        <h3 style="margin-top:0" id="modal-title-alarm">Tambah Data Alarm</h3>
        <input type="hidden" id="edit-idx">
        <input type="text" id="in-unit" placeholder="Unit (Contoh: TRAFO 1)">
        <input type="text" id="in-alarm" placeholder="Nama Alarm">
        <textarea id="in-maksud" rows="2" placeholder="Maksud Indikasi"></textarea>
        <textarea id="in-sebab" rows="2" placeholder="Penyebab"></textarea>
        <textarea id="in-tindakan" rows="2" placeholder="Tindakan"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn btn-primary btn-full" onclick="saveAlarm()">Simpan</button>
            <button class="btn btn-secondary btn-full" onclick="closeModal('modal-alarm')">Batal</button>
        </div>
    </div>
</div>

<div id="modal-contact" class="overlay">
    <div class="modal">
        <h3 style="margin-top:0">Data Kontak</h3>
        <input type="hidden" id="contact-idx">
        <input type="text" id="in-nama" placeholder="Nama / Instansi">
        <input type="number" id="in-nomor" placeholder="Nomor Telepon">
        <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn btn-primary btn-full" onclick="saveContact()">Simpan</button>
            <button class="btn btn-secondary btn-full" onclick="closeModal('modal-contact')">Batal</button>
        </div>
    </div>
</div>

<div id="loader"><div class="spinner"></div><div id="loader-text">Memproses data...</div></div>

<script>
// --- DATABASE LENGKAP ---
const INITIAL_DB = [
    {s:"TRAFO 1", a:"CB Q0 ‚Äì On Local", m:"Posisi PMT pada posisi Local", p:"Switch R/S pada posisi remote atau local", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"DS Q1/Q2 On Local", m:"Posisi PMS Rel Posisi Local", p:"Switch R/S pada posisi remote atau local", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"Common Trafo Alarm", m:"Ada Rele Lock Out mekanik yang kerja di Panel Regulator Trafo", p:"Ada gangguan Internal trafo (Winding HV / LV alarm , Buchols alarm , Oil level ) yang terdeteksi Rele mekanik", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"Alarm SF6 Low Level", m:"Ada penurunan tekanan Gas SF6 di PMT sampai level Alarm ( 5,6 BAR )", p:"Ada kebocoran di system pengisian maupun kerusakan seal di PMT", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"CB lockout SF6 Operated", m:"Ada penurunan tekanan Gas SF6 di PMT sampai level Lockout", p:"Ada kebocoran di system pengisian maupun kerusakan seal di PMT", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"CB Mecanic Spring Discarge", m:"Pegas PMT tidak siap untuk operasi", p:"Suplay 110 untuk motor terganggu ,mekanik pengisian pegas rusak", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"CB Supplay Failure", m:"Ada gangguan suplay DC 380 V pada PMT", p:"MCB 3 pole QF1 di MK Trip", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"DS Q1/Q2 Supplay Fail", m:"Ada gangguan suplay PMS Rel di MK", p:"MCB untuk suplay motor PMS Trip ,ada kerusakan mekanik PMS", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"Common Trafo Trip", m:"PMT 150/20 KV Trip karena gangguan internal Trafo hingga Rele Lock out di Panel Regulator bekerja", p:"Gangguan internal yang dideteksi oleh Rele mekanik Trafo al.Buchols Trip , Jansen Trip ,Sudden Pressure Trip", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"MK Supplay Trip", m:"Ada gangguan pada suplay 380V ke MK", p:"MCB untuk supplay ke MK di ACDB trip atau Ada short circuit", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"TCS 1 Failure", m:"PMT tidak siap trip karena rele trip circuit supervisori (TCS)", p:"Ada kegagala rangkaian Triping coil PMT No 1 dan No 2 atau interlok tegangan negatif", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"TCS 2 Failure", m:"PMT tidak siap trip karena rele trip circuit supervisori (TCS)", p:"Ada kegagala rangkaian Triping coil PMT No 1 dan No 2 atau interlok tegangan negatif", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"Lockout Operated", m:"Master Trip mengerjakan lockout", p:"Ada gangguan yang menyebabkan trip dan perlu investigasi lanjut", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 1", a:"BVT MCB Trip", m:"MCB VT busbar trip di MK", p:"Ada sort sirkit di beban VT ataupun ada beban yang melebih kapasitas MCB VT", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 3", a:"F87 TRIP", m:"PMT 150/20 kV Trip karena Rele Differential Trafo Bekerja", p:"Ada gangguan hubung singkat di kumparan Trafo ataupun di daerah pengamanannya (antara CT 150 kV dan 20 kV)", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"F87 FAIL", m:"Rele Differential Trafo Bekerja", p:"Ada gangguan hubung singkat di kumparan Trafo ataupun di daerah pengamanannya (antara CT 150 kV dan 20 kV)", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Bus Coupler Close", m:"Indikasi PMT 150 KV Kopel Masuk", p:"PMT 150 KV Kopel Masuk", t:"Periksa, catat"},
    {s:"TRAFO 3", a:"Incoming 20 KV TRIP", m:"PMT 20 KV Incoming Trafo Trip", p:"Indikasi PMT 20 kv incoming keluar atau ada Ada gangguan hubung singkat antara fasa-fasa dan fasa ke tanah", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Bucholz Trip", m:"PMT 150 kV Trip karena Rele Bucholz Bekerja", p:"Adanya gangguan hubung singkat di kumparan Trafo yang mengakibatkan timbul gelembung gas dalam Trafo", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Oil Temperature Trip", m:"PMT 150/20 kV Trip karena ada gangguan Internal Trafo yang terdeteksi Rele Mekanis Trafo hingga Level Trip", p:"Rele mekanis Oil Temp bekerja karena adanya kenaikan suhu trafo akibat beban lebih atau sistem pendingin tidak bekerja sempurna", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Sudden Pressure Trip", m:"PMT 150/20 kV Trip karena ada gangguan Internal Trafo yang terdeteksi Rele Mekanis Trafo hingga Level Trip", p:"Rele mekanis Sudden Pressure bekerja karena adanya kenaikan tekanan gas yang sangat cepat di dalam trafo akibat gangguan hubung singkat internal trafo", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Jansen Trip", m:"PMT 150 kV Trip karena ada gangguan di OLTC Trafo yang terdeteksi Rele Jansen", p:"Rele mekanis Jansen bekerja because adanya gangguan di kompartemen OLTC", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"HV/LV Winding Trip", m:"PMT 150/20 kV Trip karena ada gangguan Internal Trafo yang terdeteksi Rele Mekanis Trafo hingga Level Trip", p:"Rele mekanis Winding Temp. bekerja karena adanya kenaikan suhu trafo yang diakibatkan beban lebih atau gangguan internal trafo", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Fire Protection Trip", m:"PMT 150/20 kV Trip karena Rele Fire Protection bekerja", p:"Terdeteksi kebakaran di area Trafo", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Low Oil Level Trip", m:"PMT 150/20 kV Trip karena ada penurunan level oli sampai batas minimal", p:"Terjadi kebocoran oli trafo yang sangat banyak", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Oil Temperature Alarm", m:"Terjadinya kenaikan suhu pada oli trafo", p:"Rele mekanis Oil Temp. bekerja karena adanya kenaikan suhu oli trafo yang diakibatkan gangguan internal Trafo pada tahap alarm", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Bucholz Alarm", m:"Terdeteksi gelembung gas pada rele bucholz", p:"Adanya gangguan hubung singkat di kumparan Trafo yang mengakibatkan timbul gelembung gas dalam Trafo dalam jumlah sedikit", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Oil Level Alarm", m:"Level oli trafo pada posisi alarm (Low/High)", p:"Adanya kebocoran oli atau pemuaian oli akibat suhu tinggi", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"OLTC Oil Level Alarm", m:"Level oli pada kompartemen OLTC pada posisi alarm", p:"Adanya kebocoran oli pada OLTC", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"Sudden Pressure Alarm", m:"Terdeteksi kenaikan tekanan secara tiba-tiba (tahap alarm)", p:"Adanya gangguan internal trafo yang menimbulkan tekanan gas", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"WTI HV Alarm", m:"Terjadinya kenaikan suhu pada Winding Primer trafo", p:"Rele mekanis Winding HV Temp. bekerja karena adanya kenaikan suhu trafo yang diakibatkan gangguan internal Trafo pada tahap alarm", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"WTI LV Alarm", m:"Terjadinya kenaikan suhu pada Winding Sekunder trafo", p:"Rele mekanis Winding LV Temp. bekerja karena adanya kenaikan suhu trafo yang diakibatkan gangguan internal Trafo pada tahap alarm", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"DS/CB Lokal", m:"Switch Remote/Lokal DS & CB posisi Lokal", p:"Switch Remote/Lokal DS & CB posisi Lokal", t:"Periksa, catat"},
    {s:"TRAFO 3", a:"F502& F503 TRIP", m:"PMT 150 kV trip karena rele OCR & SBEF di sisi 20 kV trafo bekerja", p:"Ada gangguan hubung singkat antara fasa fasa dan fasa ke tanah", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"F502& F503 FAIL", m:"Rele OCR & SBEF di sisi 20 kV trafo tidak dapat bekerja", p:"Ada gangguan internal di rele OCR & SBEF", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"CB SF6 ALARM", m:"Ada penurunan tekanan Gas SF6 di PMT sampai level Alarm", p:"Ada kebocoran di system pengisian maupun kerusakan seal di PMT", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 3", a:"CB SF6 LOCKOUT", m:"Ada penurunan tekanan Gas SF6 di PMT sampai level Lockout", p:"Ada kebocoran di system pengisian maupun kerusakan seal di PMT", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"TRAFO 4", a:"Diff Relay Operated", m:"PMT 150/20 KV trip karena Rele Differensial Trafo phasa R bekerja", p:"Ada gangguan hubung singkat di kumparan trafo ataupun di daerah pengamanannya ( antara CT 150 KV dan CT 20 KV )", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"OCR,GFR,SEF", m:"PMT 150KV Trip karena Relay OCR,GFR,SEF Kerja", p:"Ada gangguan hubung singkat phasa ke tanah sisi 150 KV Trafo", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"BUCHHOLTZ TRIP", m:"PMT 150KV Trip karena relay bucholtz kerja", p:"Gangguan internal yang dideteksi oleh Rele mekanik Trafo al.Buchols Trip , Jansen Trip ,Sudden Pressure Trip", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"WINDING TEMP TRIP", m:"PMT 150KV Trip karena relay temperature kerja", p:"Gangguan internal yang dideteksi oleh Rele mekanik Trafo al.Buchols Trip , Jansen Trip ,Sudden Pressure Trip", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"Over Pressure Tank", m:"PMT 150KV Trip karena reley mekanik kerja", p:"Gangguan internal yang dideteksi oleh Rele mekanik Trafo al.Buchols Trip , Jansen Trip ,Sudden Pressure Trip", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"110 V VT Falut", m:"Suplay 110 V DC VT Hilang", p:"Ada gangguan pada suplay tegangan 110V DC dari MK", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"Over Temperature Alarm", m:"Ada gangguan pada internal trafo yang menyebabkan relay mekanik bekerja", p:"Suhu oli trafo melebihi batas setting alarm", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"Sudden Pressure Alarm", m:"Ada gangguan pada internal trafo yang menyebabkan relay mekanik bekerja", p:"Kenaikan tekanan gas secara tiba-tiba di dalam trafo", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"Buchholtz Alarm", m:"Relay mekanik (bucholtz) bekerja sampai level alarm", p:"Ada gangguan Internal trafo (Winding HV / LV alarm , Buchols alarm , Oil level ) yang terdeteksi Rele mekanik", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"Junction OLTC", m:"PMT 150KV Trip karena rele (jansen) mekanik trafo bekerja", p:"Gangguan internal yang dideteksi oleh Rele mekanik Trafo al.Buchols Trip , Jansen Trip ,Sudden Pressure Trip", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"Winding TEMP Alarm", m:"Relay mekanik (temperature) bekerja sampai level alarm", p:"Ada gangguan Internal trafo (Winding HV / LV alarm , Buchols alarm , Oil level ) yang terdeteksi Rele mekanik", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"SF6 Min/Block Presure", m:"PMT 150 KV block Trip pada saat gas SF6 mencapai level trip", p:"PMT tidak bisa trip because setting trip di blok", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"Fire Protection Operated", m:"Pengaman Kebakaran untuk trafo bekerja", p:"Ada peningkatan panas di internal trafo disertai bekerjanya semua relai pengaman utama trafo", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"TRAFO 4", a:"20 KV TRIP", m:"PMT Incoming 20 KV Trip", p:"Ada gangguan di 20 KV yang menyebbkan PMT Inc. Trip termasuk karena penyulang gagal Trip", t:"Periksa ,catat ,reset dan laporkan sesuai prosedur"},
    {s:"KOPEL", a:"DC supply failure", m:"Supply 110 V DC untuk panel control dan panel Rele hilang", p:"MCB C 001 untuk supply di panel proteksi and C 002 untuk supply di panel control trip", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"OCR Start", m:"Indikasi rele OCR 150 kV yang arus hubung singkatnya malebihi setting", p:"Ada gangguan hubung singkat antara fasa-fasa sisi 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"OCR Trip", m:"PMT 150 kV Trip karena Rele OCR 150 kV bekerja dengan indikasi OCR", p:"Ada gangguan hubung singkat antara fasa-fasa sisi 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"GFR Start", m:"Indikasi rele GFR 150 kV yang arus hubung singkatnya malebihi setting", p:"Ada gangguan hubung singkat antara fasa tanah sisi 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"GFR Trip", m:"PMT 150 kV Trip karena Rele GFR 150 kV bekerja dengan indikasi GFR", p:"Ada gangguan hubung singkat antara fasa- tanah sisi 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"PMT Bus Trip", m:"PMT 150 kV kopel Trip", p:"PMT 150 kV Trip karena rele OCR Bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"CB Failure", m:"System pengisian pegas tidak siap sehingga PMT tidak bisa trip", p:"Supply tegangan untuk pengisian motor pegas PMT Trip/terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"AC Supply Failure", m:"Supply tegangan 380 AC untuk panel control dan panel rele hilang", p:"MCB untuk supply tegangan AC di Panel Kontrol Trip", t:"Periksa, catat, reset indikasi, naikan MCB, dan laporkan"},
    {s:"KOPEL", a:"DC Supply for OCR and GFR failure", m:"Supply 110 V DC untuk Rele OCR dan Rele GFR Hilang", p:"MCB supply tegangan untuk Rele OCR and Rele GFR", t:"Periksa, catat, reset indikasi, naikan MCB, dan laporkan"},
    {s:"KOPEL", a:"SF6 stage 1 (alarm)", m:"Ada penurunan tekanan gas SF6 (5.6 BAR) pada step 1", p:"Ada kebocoran di pemipaan and motor kompresor terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"KOPEL", a:"SF6 stage 2 (trip)", m:"PMT 150 kV Trip karena penurunan Tekanan gas SF6 (5.5 BAR) pada step 2", p:"Ada kebocoran di pemipaan and pengisian motor kompresor terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"C/S/G DC SUPPLIES FAILURE", m:"Terjadi trip di MCB DC di Panel ACDB Switch L/R", p:"Tegangan supply panel Rele dan Kontrol hilang", t:"Periksa MCB di Panel ACDB, jika Trip naikan kembali"},
    {s:"CIKARANG 1", a:"CB ON LOCAL OPERATED", m:"Posisi pada Box PMT Posisi Lokal", p:"PMT tidak Bisa di operasikan secara remote baik dari Panel Maupun dari UP2B", t:"Periksa L/R pada Box PMT, Posisikan Remote Kembali"},
    {s:"CIKARANG 1", a:"T1/T2 Failure", m:"Terjadi Trip MCB Supplay Rangkaian Trip1/2 Turun", p:"Suplay tenganan untuk Rangkaian Trip terganggu", t:"Periksa MCB Suplay Rangkaian Trip, jika Trip naikan kembali"},
    {s:"CIKARANG 1", a:"Spring Charge Failure", m:"System pengisian pegas tidak siap sehingga PMT tidak bisa trip", p:"Supply tegangan untuk pengisian motor pegas PMT Trip/terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"F21 Received DTT", m:"PMT Trip karena Rele Distance menerima perintah dari GI Lawan", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 1", a:"F21 Send DTT", m:"PMT Trip karena perintah Rele Distance, Rele Mengirim Trip ke GI Lawan", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 1", a:"MK Local Position", m:"Posisi Switch L/R pada MK Posisi Lokal", p:"Peralatan Tidak Bisa di operasikan secara remote baik dari Panel Maupun dari UP2B", t:"Periksa L/R pada Switch di MK, Posisikan Remote Kembali"},
    {s:"CIKARANG 1", a:"SF6 Gas Presure Low Alarm", m:"Ada penurunan tekanan gas SF6 pada step 1", p:"Ada kebocoran di pemipaan and motor kompresor terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"SF6 Gas Presure Low Trip", m:"PMT 150 kV Trip karena penurunan Tekanan gas SF6 pada step 2", p:"Ada kebocoran di pemipaan and pengisian motor kompresor terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"Trip Circuit Failure", m:"Rangkaian Trip pada PMT Bermasalah", p:"PMT 150kV Tidak Bisa Close", t:"Periksa Rangkaian, catat, dan laporkan"},
    {s:"CIKARANG 1", a:"Pole Discrepancy Operated", m:"Ketidaksamaan posisi pole pada PMT", p:"PMT 150kV Trip", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"Main Protection 1 Trip", m:"PMT Trip karena Rele Proteksi Utama 1 bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"Main Protection 2 Trip", m:"PMT Trip karena Rele Proteksi Utama 2 bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"CB Open", m:"Indikasi PMT 150 kV dalam Kondisi Open", p:"PMT 150kV Open", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"OLS Cikarang 1 Trip", m:"Relay OLS Bekerja pengurangan beban", p:"PMT 150kV Trafo 3 Trip Akibat OLS Bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"Dead VT Line Detection Failure", m:"Tegangan Pada VT Bermasalah", p:"Tegangan yang dibaca oleh VT terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"Main Protection Failure F21", m:"Rele Distance Bermasalah", p:"Rele distance terganggu sehingga tidak dapat bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"Backup Prot Failure F5051PH+N", m:"Rele Backup (OCR) Bermasalah", p:"Rele OCR terganggu sehingga tidak dapat bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"BMQ Failure", m:"BCU Bermasalah", p:"BCU terganggu sehingga tidak dapat bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 1", a:"TCS 1/2 Failure", m:"Rangkaian Trip pada PMT Bermasalah", p:"PMT 150kV Tidak Bisa Close", t:"Periksa Rangkaian, catat, dan laporkan"},
    {s:"CIKARANG 1", a:"F21 Operated", m:"PMT Trip karena Rele Distance bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 1", a:"F50/51 Operated", m:"PMT Trip karena Rele OCR bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 1", a:"F50/51N Operated", m:"PMT Trip karena Rele GFR bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 1", a:"F87L Operated", m:"PMT Trip karena Rele Differential Line bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"C/S/G DC SUPPLIES FAILURE", m:"Terjadi trip di MCB DC di Panel ACDB", p:"Tegangan supply panel Rele dan Kontrol hilang", t:"Periksa MCB di Panel ACDB, jika Trip naikan kembali"},
    {s:"CIKARANG 2", a:"CB ON LOCAL OPERATED", m:"Posisi Switch L/R pada Box PMT Posisi Lokal", p:"PMT tidak Bisa di operasikan secara remote baik dari Panel Maupun dari UP2B", t:"Priksa L/R pada Box PMT, Posisikan Remote Kembali"},
    {s:"CIKARANG 2", a:"T1/T2 Failure", m:"Terjadi Trip MCB Supplay Rangkaian Trip1/2 Turun", p:"Suplay tenganan untuk Rangkaian Trip terganggu", t:"Periksa MCB Suplay Rangkaian Trip, jika Trip naikan kembali"},
    {s:"CIKARANG 2", a:"Spring Charge Failure", m:"System pengisian pegas tidak siap sehingga PMT tidak bisa trip", p:"Supply tegangan untuk pengisian motor pegas PMT Trip/terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"F21 Received DTT", m:"PMT Trip karena Rele Distance menerima perintah dari GI Lawan", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"F21 Send DTT", m:"PMT Trip karena Rele Distance, Rele Mengirim perintah Trip ke GI Lawan", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"MK Local Position", m:"Posisi Switch L/R pada MK Posisi Lokal", p:"Peralatan Tidak Bisa di operasikan secara remote baik dari Panel Maupun dari UP2B", t:"Periksa L/R pada Switch di MK, Posisikan Remote Kembali"},
    {s:"CIKARANG 2", a:"SF6 Gas Presure Low Alarm", m:"Ada penurunan tekanan gas SF6 pada step 1", p:"Ada kebocoran di pemipaan and motor kompresor terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"SF6 Gas Presure Low Trip", m:"PMT 150 kV Trip karena penurunan Tekanan gas SF6 pada step 2", p:"Ada kebocoran di pemipaan and pengisian motor kompresor terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"Trip Circuit Failure", m:"Rangkaian Trip pada PMT Bermasalah", p:"PMT 150kV Tidak Bisa Close", t:"Periksa Rangkaian, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"Pole Discrepancy Operated", m:"Ketidaksamaan posisi pole pada PMT", p:"PMT 150kV Trip", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"Main Protection 1 Trip", m:"PMT Trip karena Rele Proteksi Utama 1 bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"Main Protection 2 Trip", m:"PMT Trip karena Rele Proteksi Utama 2 bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"CB Open", m:"Indikasi PMT 150 kV dalam Kondisi Open", p:"PMT 150kV Open", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"OLS Cikarang 2 Trip", m:"Relay OLS Bekerja pengurangan beban", p:"PMT 150kV Trafo 3 Trip Akibat OLS Bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"Supplay AC Failure", m:"MCB Trip Pada Panel ACDB untuk Suplay AC", p:"Tegangan Suplay AC Terganggu", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"Main Protection Failure F21", m:"Rele Distance Bermasalah", p:"Rele distance terganggu sehingga tidak dapat bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"Backup Prot Failure F5051PH+N", m:"Rele Backup (OCR) Bermasalah", p:"Rele OCR terganggu sehingga tidak dapat bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"BMQ Failure", m:"BCU Bermasalah", p:"BCU terganggu sehingga tidak dapat bekerja", t:"Periksa, catat, reset indikasi, dan laporkan"},
    {s:"CIKARANG 2", a:"TCS 1/2 Failure", m:"Rangkaian Trip pada PMT Bermasalah", p:"PMT 150kV Tidak Bisa Close", t:"Periksa Rangkaian, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"F21 Operated", m:"PMT Trip karena Rele Distance bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"F50/51 Operated", m:"PMT Trip karena Rele OCR bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"F50/51N Operated", m:"PMT Trip karena Rele GFR bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"},
    {s:"CIKARANG 2", a:"F87L Operated", m:"PMT Trip karena Rele Differential Line bekerja", p:"Ada gangguan pada system 150 kV", t:"Periksa, catat, dan laporkan"}
];

const INITIAL_CONTACTS = [
    {nama: "Dispatcher UP2B", no: "021-12345678"},
    {nama: "Pemadam Kebakaran", no: "113"},
    {nama: "Polisi (Darurat)", no: "110"},
    {nama: "Rumah Sakit Terdekat", no: "118"}
];

// --- APP STATE ---
let alarms = JSON.parse(localStorage.getItem('pandu_alarms')) || INITIAL_DB;
let contacts = JSON.parse(localStorage.getItem('pandu_contacts')) || INITIAL_CONTACTS;
let db;

function openSection(id) {
    document.getElementById('main-menu').style.display = 'none';
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('btn-home').style.display = 'block';
    if(id === 'section-alarm') document.getElementById('search-input').focus();
}

function goHome() {
    document.getElementById('main-menu').style.display = 'block';
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.getElementById('btn-home').style.display = 'none';
}

// --- INDEXED DB ---
const request = indexedDB.open("PanduGIDB", 1);
request.onupgradeneeded = function(e) {
    db = e.target.result;
    if (!db.objectStoreNames.contains('sops')) db.createObjectStore('sops', { keyPath: 'id', autoIncrement: true });
};
request.onsuccess = function(e) { db = e.target.result; renderSOPs(); };

function showLoader(show, text="Memproses...") {
    const l = document.getElementById('loader');
    document.getElementById('loader-text').innerText = text;
    l.style.display = show ? 'flex' : 'none';
}

// --- ALARM LOGIC ---
function renderAlarms() {
    const list = document.getElementById('alarm-list');
    const keyword = document.getElementById('search-input').value.toLowerCase();
    list.innerHTML = "";
    const filtered = alarms.filter(item => item.s.toLowerCase().includes(keyword) || item.a.toLowerCase().includes(keyword));

    if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state">Data tidak ditemukan. <br>Klik "+ Tambah Data" untuk membuat baru.</div>';
        return;
    }

    filtered.forEach((item, index) => {
        const realIndex = alarms.indexOf(item);
        const isTrip = item.a.toLowerCase().includes('trip') || item.a.toLowerCase().includes('lockout');
        const borderClass = isTrip ? 'trip-alarm' : '';
        const html = `
            <div class="card ${borderClass}">
                <button class="delete-btn" onclick="deleteAlarm(${realIndex})">‚úï</button>
                <div class="badge">${item.s}</div>
                <h3 class="card-title" onclick="editAlarm(${realIndex})">${item.a}</h3>
                <span class="card-label">Indikasi:</span><p class="card-desc">${item.m}</p>
                <span class="card-label">Penyebab:</span><p class="card-desc">${item.p}</p>
                <span class="card-label">Tindakan:</span><p class="card-desc">${item.t}</p>
            </div>`;
        list.innerHTML += html;
    });
}
function openModal(id) {
    document.getElementById(id).style.display = 'flex';
    if(id === 'modal-alarm') {
        document.getElementById('modal-title-alarm').innerText = "Tambah Data Alarm";
        ['edit-idx','in-unit','in-alarm','in-maksud','in-sebab','in-tindakan'].forEach(i => document.getElementById(i).value = "");
    }
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function saveAlarm() {
    const idx = document.getElementById('edit-idx').value;
    const item = {
        s: document.getElementById('in-unit').value,
        a: document.getElementById('in-alarm').value,
        m: document.getElementById('in-maksud').value,
        p: document.getElementById('in-sebab').value,
        t: document.getElementById('in-tindakan').value
    };
    if(!item.s || !item.a) { alert("Unit dan Nama Alarm wajib diisi"); return; }
    if(idx === "") alarms.unshift(item); else alarms[idx] = item;
    localStorage.setItem('pandu_alarms', JSON.stringify(alarms));
    closeModal('modal-alarm'); renderAlarms();
}
function editAlarm(i) {
    const item = alarms[i];
    document.getElementById('edit-idx').value = i;
    document.getElementById('in-unit').value = item.s;
    document.getElementById('in-alarm').value = item.a;
    document.getElementById('in-maksud').value = item.m;
    document.getElementById('in-sebab').value = item.p;
    document.getElementById('in-tindakan').value = item.t;
    document.getElementById('modal-title-alarm').innerText = "Edit Data Alarm";
    openModal('modal-alarm');
}
function deleteAlarm(i) {
    if(confirm("Hapus alarm ini?")) {
        alarms.splice(i, 1);
        localStorage.setItem('pandu_alarms', JSON.stringify(alarms));
        renderAlarms();
    }
}

// --- SOP LOGIC ---
function addSOP() {
    const f = document.getElementById('sop-file');
    const n = document.getElementById('sop-name');
    if (f.files.length === 0 || !n.value) { alert("Isi nama dan pilih file."); return; }
    showLoader(true, "Menyimpan...");
    const r = new FileReader();
    r.onload = function(e) {
        const b = new Blob([e.target.result], { type: 'application/pdf' });
        const tx = db.transaction(['sops'], 'readwrite');
        tx.objectStore('sops').add({ name: n.value, blob: b, date: new Date().toLocaleDateString() });
        tx.oncomplete = function() { showLoader(false); n.value=""; f.value=""; renderSOPs(); alert("SOP tersimpan!"); };
        tx.onerror = function() { showLoader(false); alert("Gagal simpan (File terlalu besar?)"); };
    };
    r.readAsArrayBuffer(f.files[0]);
}
function renderSOPs() {
    const l = document.getElementById('sop-list');
    l.innerHTML = "<div class='spinner' style='width:20px;height:20px;border-width:2px;border-top-color:var(--primary)'></div>";
    const req = db.transaction(['sops'], 'readonly').objectStore('sops').getAll();
    req.onsuccess = function(e) {
        const fs = e.target.result;
        l.innerHTML = fs.length ? "" : "<p class='card-desc'>Belum ada dokumen.</p>";
        fs.forEach(f => {
            const u = URL.createObjectURL(f.blob);
            l.innerHTML += `<div class="card" style="display:flex;justify-content:space-between;align-items:center;"><div><h4 class="card-title" style="margin-bottom:4px">${f.name}</h4><span class="card-desc">${f.date}</span></div><div style="display:flex;gap:8px"><a href="${u}" target="_blank" class="btn btn-primary" style="padding:8px 12px">Buka</a><button class="btn btn-danger" style="padding:8px" onclick="deleteSOP(${f.id})">üóëÔ∏è</button></div></div>`;
        });
    };
}
function deleteSOP(id) {
    if(confirm("Hapus SOP?")) {
        const tx = db.transaction(['sops'], 'readwrite');
        tx.objectStore('sops').delete(id);
        tx.oncomplete = () => renderSOPs();
    }
}

// --- CONTACTS ---
function renderContacts() {
    const l = document.getElementById('contact-list'); l.innerHTML = "";
    contacts.forEach((c, i) => {
        l.innerHTML += `<div class="card" style="display:flex;justify-content:space-between;align-items:center;"><div><h4 class="card-title" style="margin-bottom:4px">${c.nama}</h4><a href="tel:${c.no}" class="card-desc" style="color:var(--primary);font-weight:700;text-decoration:none">${c.no}</a></div><button class="btn btn-danger" style="padding:8px" onclick="deleteContact(${i})">üóëÔ∏è</button></div>`;
    });
}
function saveContact() {
    const n = document.getElementById('in-nama').value;
    const no = document.getElementById('in-nomor').value;
    if(!n || !no) return;
    contacts.push({nama:n, no:no});
    localStorage.setItem('pandu_contacts', JSON.stringify(contacts));
    closeModal('modal-contact'); renderContacts();
    document.getElementById('in-nama').value=""; document.getElementById('in-nomor').value="";
}
function deleteContact(i) {
    if(confirm("Hapus kontak?")) {
        contacts.splice(i, 1);
        localStorage.setItem('pandu_contacts', JSON.stringify(contacts));
        renderContacts();
    }
}

// --- BACKUP RESTORE ---
function backupData() {
    const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ alarms: alarms, contacts: contacts }));
    const a = document.createElement('a');
    a.href = d; a.download = "backup_pandugi_" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a); a.click(); a.remove();
}
function restoreData() {
    const f = document.getElementById('restore-file');
    if(!f.files.length) return;
    const r = new FileReader();
    r.onload = function(e) {
        try {
            const d = JSON.parse(e.target.result);
            if(d.alarms && d.contacts && confirm("Timpa data lama?")) {
                alarms = d.alarms; contacts = d.contacts;
                localStorage.setItem('pandu_alarms', JSON.stringify(alarms));
                localStorage.setItem('pandu_contacts', JSON.stringify(contacts));
                alert("Data pulih!"); renderAlarms(); renderContacts();
            }
        } catch(err) { alert("File error."); }
    };
    r.readAsText(f.files[0]);
}
function clearAllData() {
    if(confirm("Hapus SEMUA data?")) {
        localStorage.clear();
        const req = indexedDB.deleteDatabase("PanduGIDB");
        req.onsuccess = function() { location.reload(); };
    }
}

renderAlarms(); renderContacts();
</script>
</body>
</html>
